<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Stable Fluids 2D 1</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				color: #ffffff;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
			}

		</style>
	</head>
	<body>

		<div id="container"></div>

		<script src="js/Detector.js"></script>
		<script src="three.min.js"></script>

		<script>

			//WEBGL

			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();

			var container, camera, renderer;
			var scene;

			//CONSTANTS
			var N = 5;
			var size = (N+2)*(N+2);
			var h = 1/N;
			var dt = 0.1;
			var diff = 0.0;
			var visc = 0.0;
			var force = 5.0;
			var source = 100.0;

			//UTILS
			function IX(i,j){
				return i + (N+2)* j;			
			}

			function swap(a, b){
				var tmp = a;
				a = b;
				b = tmp;
			}

			//DATA
			var U = [], U_prev = [], V = [], V_prev = [], dens = [], dens_prev = [];

			function clear_data()
			{
				for ( var i = 0 ; i < size ; i++ ) {
					U[i] = V[i] = U_prev[i] = V_prev[i] = dens[i] = dens_prev[i] = 0.0;
				}
			}

			function add_source ( x, s )
			{
				for ( i=0 ; i<size ; i++ ) x[i] += dt*s[i];
			}

			function set_bnd ( b, x )
			{
				for ( var i=1 ; i<=N ; i++ ) {
					x[IX(0  ,i)] = b==1 ? -x[IX(1,i)] : x[IX(1,i)];
					x[IX(N+1,i)] = b==1 ? -x[IX(N,i)] : x[IX(N,i)];
					x[IX(i,0  )] = b==2 ? -x[IX(i,1)] : x[IX(i,1)];
					x[IX(i,N+1)] = b==2 ? -x[IX(i,N)] : x[IX(i,N)];
				}
				
				x[IX(0  ,0  )] = 0.5*(x[IX(1,0  )]+x[IX(0  ,1)]);
				x[IX(0  ,N+1)] = 0.5*(x[IX(1,N+1)]+x[IX(0  ,N)]);
				x[IX(N+1,0  )] = 0.5*(x[IX(N,0  )]+x[IX(N+1,1)]);
				x[IX(N+1,N+1)] = 0.5*(x[IX(N,N+1)]+x[IX(N+1,N)]);
			}

			function lin_solve ( b, x, x0, a, c )
			{
				for ( var k=0 ; k<20 ; k++ ) {
					for(var i = 1; i <= N; i++)
						for (var j = 1; j <= N; j++) 
							x[IX(i,j)] = (x0[IX(i,j)] + a*(x[IX(i-1,j)]+x[IX(i+1,j)]+x[IX(i,j-1)]+x[IX(i,j+1)]))/c;
					set_bnd ( N, b, x );
				}
			}

			function diffuse ( b, x, x0 )
			{
				var a=dt*diff*N*N;
				lin_solve ( b, x, x0, a, 1+4*a );
			}

			function advect ( b, d, d0, u, v )
			{
				var i0, j0, i1, j1;
				var x, y, s0, t0, s1, t1, dt0;

				dt0 = dt*N;
				for(var i = 1; i <= N; i++)
						for (var j = 1; j <= N; j++){ 
							x = i-dt0*u[IX(i,j)]; y = j-dt0*v[IX(i,j)];
							if (x<0.5) x=0.5; if (x>N+0.5) x=N+0.5; i0=Math.floor(x); i1=i0+1;
							if (y<0.5) y=0.5; if (y>N+0.5) y=N+0.5; j0=Math.floor(y); j1=j0+1;
							s1 = x-i0; s0 = 1-s1; t1 = y-j0; t0 = 1-t1;
							d[IX(i,j)] = s0*(t0*d0[IX(i0,j0)]+t1*d0[IX(i0,j1)])+
										 s1*(t0*d0[IX(i1,j0)]+t1*d0[IX(i1,j1)]);
						}
				set_bnd ( N, b, d );
			}

			function project ( u, v, p, div )
			{
				for(var i = 1; i <= N; i++)
						for (var j = 1; j <= N; j++){ 
							div[IX(i,j)] = -0.5*(u[IX(i+1,j)]-u[IX(i-1,j)]+v[IX(i,j+1)]-v[IX(i,j-1)])/N;
							p[IX(i,j)] = 0;
						}	
				set_bnd ( N, 0, div ); set_bnd ( N, 0, p );

				lin_solve ( 0, p, div, 1, 4 );

				for(var i = 1; i <= N; i++)
					for (var j = 1; j <= N; j++){ 
						u[IX(i,j)] -= 0.5*N*(p[IX(i+1,j)]-p[IX(i-1,j)]);
						v[IX(i,j)] -= 0.5*N*(p[IX(i,j+1)]-p[IX(i,j-1)]);
					}
				set_bnd ( N, 1, u ); set_bnd ( N, 2, v );
			}

			function dens_step ( x, x0, u, v )
			{
				add_source ( N, x, x0, dt );
				swap ( x0, x ); diffuse ( N, 0, x, x0, diff, dt );
				swap ( x0, x ); advect ( N, 0, x, x0, u, v, dt );
			}

			function vel_step ( u, v, u0, v0 )
			{
				add_source ( N, u, u0, dt ); add_source ( N, v, v0, dt );
				swap ( u0, u ); diffuse ( N, 1, u, u0, visc, dt );
				swap ( v0, v ); diffuse ( N, 2, v, v0, visc, dt );
				project ( N, u, v, u0, v0 );
				swap ( u0, u ); swap ( v0, v );
				advect ( N, 1, u, u0, u0, v0, dt ); advect ( N, 2, v, v0, u0, v0, dt );
				project ( N, u, v, u0, v0 );
			}
			
			init();
			//animate();

			function init() {
				container = document.getElementById( 'container' );

				camera = new THREE.OrthographicCamera( 0, 1, 0, 1, -1, 1 );
				camera.position.z = 1;

				renderer = new THREE.WebGLRenderer();
				renderer.setSize( window.innerWidth, window.innerHeight );
				renderer.autoClear = true;

				container.appendChild( renderer.domElement );

				document.addEventListener( 'mousemove', onDocumentMouseMove, false );

				clear_data();

				//SCENE
				scene = new THREE.Scene();

				for(var i = 1; i <= N; i++)
					for(var j = 1; j <= N; j++){
						var particle = new THREE.Particle( new THREE.ParticleCanvasMaterial( { color: 0x666666 } ) );
    					particle.position.x = (i-0.5)*h;
    					particle.position.y = (j-0.5)*h;
    					particle.scale.x = particle.scale.y = 1;
    					console.log(particle.position.x + " " + particle.position.y);
    					particle.position.z = 0;
    					scene.add(particle);
					}


			}

			function onDocumentMouseMove( event ) {
			
			}

			function animate() {

				requestAnimationFrame( animate );

				render();
			}


			function drawGrid(){

			}


			function render() {
				//get_from_UI ( dens_prev, u_prev, v_prev );
				vel_step ( U, V, U_prev, V_prev );
				dens_step ( dens, dens_prev, U, V );

				renderer.render( scene, camera );
			}
				
		</script>
	</body>
</html>
